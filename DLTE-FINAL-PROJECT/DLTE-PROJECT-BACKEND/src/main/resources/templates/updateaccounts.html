<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjIcsSv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
            integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
            crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <style>
        body {
            background-size: cover;
            background-attachment: fixed;
        }

        .custom-form {
            /*border: 2px solid #182052;*/
            background-color: #182052;
            color: #ffffff;
            border-radius: 20px !important;
        }

        .custom-button3 {
            background-color: #ffffff !important;
            color: #182052 !important;
            border-radius: 20px !important;
            width: 100px !important;
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body>
<header th:insert="header :: head"></header>
<div class="container">
    <div class="row justify-content-center">
        <div id="status" class="display-6 text-center text-primary"></div>
        <div class="p-5 m-5 rounded-5 shadow custom-form">
            <h1 style="color: aliceblue; text-align: center;">Close Account Service</h1>
            <div class="form group">
                <label>Account Number</label>
                <input type="number" id="accountNumber" class="form-control" placeholder="Account Number" readonly/>
                <small id="accountNumberError" class="text-danger"></small>
            </div>
            <div class="form group">
                <label>Account Type</label>
                <input type="text" id="accountType" class="form-control" placeholder="Account Type" readonly/>
                <small id="accountTypeError" class="text-danger"></small>
            </div>
            <div class="form group">
                <label>Account status</label>
                <input type="text" id="accountStatus" class="form-control" placeholder="Account Status" readonly/>
                <small id="accountStatusError" class="text-danger"></small>
            </div>
            <div class="form group">
                <label>Account Balance</label>
                <input type="number" id="accountBalance" class="form-control" placeholder="Account Balance" readonly/>
                <small id="accountBalanceError" class="text-danger"></small>
            </div>
            <div class="row justify-content-center mt-3">
                <div class="col-md-4 mb-3">
                    <button id="add" class="btn custom-button3 w-100"><p class="display-6 bi bi-cash-coin"></p> Confirm
                    </button>
                </div>
                <div class="col-md-4 mb-3">
                    <button id="cancel" class="btn custom-button3 w-100" onclick="window.history.back();"><p
                            class="display-6 bi bi-escape"></p> Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal" id="updateModal2">
    <div class="modal-dialog">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header justify-content-center">
                <img th:src="@{'/images/correct.png'}" alt="Alert Image">
            </div>
            <!-- Modal body -->
            <div class="modal-body text-center">
                <p id="successMessage" style="color: #182052; font-family: 'Poppins', sans-serif;"></p>
                <!--                <p>Click <span style="color: #182052; font-family: 'Poppins', sans-serif;">Back to Dashboard</span> to go back to Dashboard</p>-->
            </div>
            <!-- Modal footer -->
            <div class="modal-footer justify-content-center">
                <!--                <button href="/customer/update" type="button" class="col-10 col-md-4 btn btn-outline-white rounded-pill" id="backHome" >OK</button>-->
            </div>
        </div>
    </div>
</div>

<div class="modal" id="updateModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header justify-content-center">
                <p id="errorCode" style="color: #182052; font-family: 'Poppins', sans-serif;"></p>
            </div>
            <!-- Modal body -->
            <div class="modal-body text-center">
                <p id="errorMessage" style="color: #182052; font-family: 'Poppins', sans-serif;"></p>
            </div>
            <!-- Modal footer -->
            <div class="modal-footer justify-content-center">
            </div>
        </div>
    </div>
</div>


<!-- Modal for password input -->
<div class="modal" id="passwordModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header justify-content-center">
                <h5 class="modal-title">Enter Password</h5>
            </div>
            <!-- Modal body -->
            <div class="modal-body">
                <div class="form-group">
                    <label for="inputPassword">Password</label>
                    <input type="password" class="form-control" id="inputPassword" placeholder="Enter your password">
                    <small id="passwordError" class="form-text text-danger"></small>
                </div>
            </div>
            <!-- Modal footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="confirmPassword">Confirm</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>


</body>
<footer th:insert="footer :: foot"></footer>
<script>
    function validation() {
        const accountNumber = $("#accountNumber").val();
        const accountType = $("#accountType").val();
        const accountStatus = $("#accountStatus").val();
        const accountBalance = $("#accountBalance").val();
        let isValid = true;

        // Account Number validation
        if (accountNumber.trim() === '') {
            $("#accountNumberError").text("Account Number is required");
            isValid = false;
        } else {
            $("#accountNumberError").text('');
        }

        // Account Type validation
        if (accountType.trim() === '') {
            $("#accountTypeError").text("Account Type is required");
            isValid = false;
        } else {
            $("#accountTypeError").text('');
        }

        // Account Status validation
        if (accountStatus.trim() === '') {
            $("#accountStatusError").text("Account Status is required");
            isValid = false;
        } else {
            $("#accountStatusError").text('');
        }

        // Account Balance validation
        if (accountBalance.trim() === '') {
            $("#accountBalanceError").text("Account Balance is required");
            isValid = false;
        } else if (isNaN(accountBalance)) {
            $("#accountBalanceError").text("Account Balance must be a number");
            isValid = false;
        } else {
            $("#accountBalanceError").text('');
        }
        return isValid;
    }


    $(document).ready(() => {
        // $(".modal-footer").click(function(event) {
        //     event.preventDefault();
        //
        //     window.location.href = "/customer/update";
        // });
        function hideModal() {
            $('#updateModal').modal('hide');
        }

        // Retrieve account details from session storage
        const storedAccountDetails = sessionStorage.getItem('accountDetails');
        const accountDetails = JSON.parse(storedAccountDetails);

        $("#accountId").val("***");
        $("#accountNumber").val(accountDetails.accountNumber);
        $("#customerId").val("***");
        $("#accountType").val(accountDetails.accountType);
        $("#accountStatus").val(accountDetails.accountStatus);
        $("#accountBalance").val(accountDetails.accountBalance);

        $("#add").click(() => {
            if (validation()) {
                const request = {
                    "accountNumber": accountDetails.accountNumber,
                    "accountType": accountDetails.accountType,
                    "accountStatus": accountDetails.accountStatus,
                    "accountBalance": accountDetails.accountBalance
                };
                $.ajax({
                    url: "http://localhost:8082/accounts/closeAccounts",
                    type: "PUT",
                    dataType: "text",
                    contentType: "application/json;charset=utf-8",
                    data: JSON.stringify(request),
                    success: function (response) {
                        console.log(response);
                        var excRegex = /EXC00\d\s*:/;
                        if (excRegex.test(response)) {
                            var errorMessage = response.replace(excRegex, '').trim();
                            var errorCode = response.match(excRegex)[0].trim();
                            //window.location.href = "/customer/error/?message=" + encodeURIComponent(errorMessage)  + "&code=" + encodeURIComponent(errorCode);
                            $("#errorMessage").text(errorMessage);
                            $("#errorCode").text(errorCode);
                            $("#updateModal").modal("show");
                            setTimeout(hideModal, 3000);
                        } else {
                            var responseMessage = response.replace(/^{.*?}(.*)$/, '$1').trim();
                            $("#successMessage").text(responseMessage);
                            $("#updateModal2").modal("show");
                            //setTimeout(hideModal, 3000);
                            setTimeout(function () {
                                $('#updateModal2').modal('hide');
                            }, 3000);
                            sessionStorage.removeItem('accountDetails');
                        }
                    },
                    error: function (xhr, status, error) {
                        // If there's an error in the AJAX request itself
                        let errorMessage = xhr.responseText;
                        let errorCode = 200; // Assuming 200 for error status
                        window.location.href = "/customer/error/?message=" + encodeURIComponent(errorMessage) + "&code=" + encodeURIComponent(errorCode);
                    }
                });
            }
        });
    });
</script>


</html>
